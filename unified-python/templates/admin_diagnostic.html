<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin User Diagnostic - Prompt House Premium</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8fafc;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background: #4338ca;
        }
        .btn-danger {
            background: #dc2626;
        }
        .btn-danger:hover {
            background: #b91c1c;
        }
        .btn-success {
            background: #059669;
        }
        .btn-success:hover {
            background: #047857;
        }
        .result {
            background: #f1f5f9;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .error {
            background: #fef2f2;
            border-left-color: #dc2626;
            color: #991b1b;
        }
        .success {
            background: #f0fdf4;
            border-left-color: #059669;
            color: #065f46;
        }
        .warning {
            background: #fffbeb;
            border-left-color: #d97706;
            color: #92400e;
        }
        .user-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .expected-admin {
            border-left: 4px solid #059669;
        }
        .unauthorized-admin {
            border-left: 4px solid #dc2626;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #1e293b;
        }
        .stat-label {
            color: #64748b;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Admin User Diagnostic Tool</h1>
        <p>Investigate and fix admin user privileges in your Coolify deployment</p>
    </div>

    <div class="card">
        <h2>Quick Actions</h2>
        <button class="btn" onclick="checkAllAdmins()">Check All Admin Users</button>
        <button class="btn" onclick="checkSpecificUser('chenjg223157@gmail.com')">Check chenjg223157@gmail.com</button>
        <button class="btn" onclick="checkSpecificUser('isky999@gmail.com')">Check Expected Admin</button>
        <button class="btn" onclick="getDatabaseStats()">Get Database Stats</button>
        <button class="btn btn-danger" onclick="fixAdminPrivileges()" id="fixBtn">üîß Fix Admin Privileges</button>
    </div>

    <div class="card">
        <h2>üîç Session Diagnostics</h2>
        <button class="btn btn-success" onclick="getCurrentUser()">Check Current Logged-In User</button>
        <button class="btn" onclick="searchUserByEmail('chenjg223157@gmail.com')">Deep Search chenjg223157@gmail.com</button>
        <button class="btn" onclick="getAllUsersDetailed()">Get All Users (Detailed)</button>
        <button class="btn" onclick="debugAuthFlow()">Debug Auth Flow</button>
        <button class="btn btn-danger" onclick="fixSpecificUser('chenjg223157@gmail.com')">Remove Admin from chenjg223157@gmail.com</button>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        Processing request...
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = '/api/admin-diagnostic';
        const SESSION_API_BASE = '/api/session-diagnostic';
        
        function showLoading(show = true) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showResult(content, type = 'info') {
            const results = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = content;
            results.appendChild(resultDiv);
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function apiCall(endpoint, method = 'GET') {
            showLoading(true);
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, 'error');
                throw error;
            } finally {
                showLoading(false);
            }
        }
        
        async function checkAllAdmins() {
            clearResults();
            try {
                const data = await apiCall('/check-all-admins');
                
                let html = `<h3>üìä Admin Users Report</h3>`;
                html += `<div class="stats-grid">`;
                html += `<div class="stat-item"><div class="stat-number">${data.total_admin_users}</div><div class="stat-label">Total Admin Users</div></div>`;
                html += `<div class="stat-item"><div class="stat-number">${data.expected_admin_found ? '‚úÖ' : '‚ùå'}</div><div class="stat-label">Expected Admin Found</div></div>`;
                html += `<div class="stat-item"><div class="stat-number">${data.unauthorized_admins.length}</div><div class="stat-label">Unauthorized Admins</div></div>`;
                html += `</div>`;
                
                if (data.admin_users.length > 0) {
                    html += `<h4>Admin Users:</h4>`;
                    data.admin_users.forEach(user => {
                        const isExpected = user.email === 'isky999@gmail.com';
                        const cardClass = isExpected ? 'expected-admin' : 'unauthorized-admin';
                        html += `
                            <div class="user-card ${cardClass}">
                                <strong>${isExpected ? '‚úÖ' : '‚ö†Ô∏è'} ${user.email}</strong><br>
                                Name: ${user.first_name || 'N/A'} ${user.last_name || 'N/A'}<br>
                                Auth Provider: ${user.auth_provider}<br>
                                Active: ${user.is_active ? 'Yes' : 'No'}<br>
                                Created: ${user.created_at ? new Date(user.created_at).toLocaleString() : 'N/A'}<br>
                                ${isExpected ? '<em>This is the expected admin user</em>' : '<em>This user should NOT be admin</em>'}
                            </div>
                        `;
                    });
                }
                
                if (data.unauthorized_admins.length > 0) {
                    html += `<div class="result warning">‚ö†Ô∏è Found ${data.unauthorized_admins.length} unauthorized admin user(s). Consider using the "Fix Admin Privileges" button.</div>`;
                }
                
                showResult(html, data.unauthorized_admins.length === 0 ? 'success' : 'warning');
            } catch (error) {
                // Error already shown by apiCall
            }
        }
        
        async function checkSpecificUser(email) {
            clearResults();
            try {
                const data = await apiCall(`/check-user/${encodeURIComponent(email)}`);
                
                let html = `<h3>üë§ User Details: ${email}</h3>`;
                const user = data.user_details;
                const statusIcon = data.admin_status_correct ? '‚úÖ' : '‚ö†Ô∏è';
                
                html += `
                    <div class="user-card ${data.is_expected_admin ? 'expected-admin' : (user.is_admin ? 'unauthorized-admin' : '')}">
                        <strong>${statusIcon} ${user.email}</strong><br>
                        Name: ${user.first_name || 'N/A'} ${user.last_name || 'N/A'}<br>
                        Is Admin: ${user.is_admin ? 'Yes' : 'No'}<br>
                        Should Be Admin: ${data.should_be_admin ? 'Yes' : 'No'}<br>
                        Auth Provider: ${user.auth_provider}<br>
                        Active: ${user.is_active ? 'Yes' : 'No'}<br>
                        Created: ${user.created_at ? new Date(user.created_at).toLocaleString() : 'N/A'}<br>
                        Updated: ${user.updated_at ? new Date(user.updated_at).toLocaleString() : 'N/A'}<br>
                        <br>
                        <strong>Status: ${data.admin_status_correct ? '‚úÖ Correct' : '‚ö†Ô∏è Incorrect'}</strong>
                    </div>
                `;
                
                if (!data.admin_status_correct) {
                    html += `<div class="result warning">‚ö†Ô∏è This user's admin status is incorrect and should be fixed.</div>`;
                }
                
                showResult(html, data.admin_status_correct ? 'success' : 'warning');
            } catch (error) {
                // Error already shown by apiCall
            }
        }
        
        async function getDatabaseStats() {
            clearResults();
            try {
                const data = await apiCall('/database-stats');
                
                let html = `<h3>üìà Database Statistics</h3>`;
                html += `<div class="stats-grid">`;
                html += `<div class="stat-item"><div class="stat-number">${data.total_users}</div><div class="stat-label">Total Users</div></div>`;
                html += `<div class="stat-item"><div class="stat-number">${data.active_users}</div><div class="stat-label">Active Users</div></div>`;
                html += `<div class="stat-item"><div class="stat-number">${data.admin_users}</div><div class="stat-label">Admin Users</div></div>`;
                html += `<div class="stat-item"><div class="stat-number">${data.google_auth_users}</div><div class="stat-label">Google Auth Users</div></div>`;
                html += `<div class="stat-item"><div class="stat-number">${data.local_auth_users}</div><div class="stat-label">Local Auth Users</div></div>`;
                html += `<div class="stat-item"><div class="stat-number">${data.inactive_users}</div><div class="stat-label">Inactive Users</div></div>`;
                html += `</div>`;
                
                showResult(html, 'success');
            } catch (error) {
                // Error already shown by apiCall
            }
        }
        
        async function fixAdminPrivileges() {
            if (!confirm('‚ö†Ô∏è This will remove admin privileges from all unauthorized users and ensure only isky999@gmail.com has admin privileges. Are you sure?')) {
                return;
            }
            
            clearResults();
            try {
                const data = await apiCall('/fix-admin-privileges', 'POST');
                
                let html = `<h3>üîß Admin Privileges Fixed</h3>`;
                html += `<div class="stats-grid">`;
                html += `<div class="stat-item"><div class="stat-number">${data.changes_made.unauthorized_admins_removed}</div><div class="stat-label">Unauthorized Admins Removed</div></div>`;
                html += `<div class="stat-item"><div class="stat-number">${data.changes_made.expected_admin_updated ? '‚úÖ' : '‚ûñ'}</div><div class="stat-label">Expected Admin Updated</div></div>`;
                html += `<div class="stat-item"><div class="stat-number">${data.after_fix.total_admins}</div><div class="stat-label">Final Admin Count</div></div>`;
                html += `</div>`;
                
                html += `<h4>Before Fix:</h4>`;
                html += `<p>Admin users: ${data.before_fix.admin_emails.join(', ') || 'None'}</p>`;
                
                html += `<h4>After Fix:</h4>`;
                html += `<p>Admin users: ${data.after_fix.admin_emails.join(', ') || 'None'}</p>`;
                
                if (data.warning) {
                    html += `<div class="result warning">‚ö†Ô∏è ${data.warning}</div>`;
                }
                
                html += `<div class="result success">‚úÖ ${data.message}</div>`;
                
                showResult(html, 'success');
            } catch (error) {
                // Error already shown by apiCall
            }
        }
        
        // Session diagnostic functions
        async function getCurrentUser() {
            clearResults();
            try {
                const data = await fetch(`${SESSION_API_BASE}/current-user`).then(r => r.json());
                
                let html = `<h3>üë§ Current Logged-In User</h3>`;
                
                if (data.authenticated) {
                    const user = data.user;
                    const analysis = data.admin_status_analysis;
                    
                    html += `
                        <div class="user-card ${analysis.admin_issue_detected ? 'unauthorized-admin' : (user.is_admin ? 'expected-admin' : '')}">
                            <strong>${analysis.admin_issue_detected ? '‚ö†Ô∏è' : (user.is_admin ? '‚úÖ' : 'üë§')} ${user.email}</strong><br>
                            Name: ${user.first_name || 'N/A'} ${user.last_name || 'N/A'}<br>
                            Is Admin: ${user.is_admin ? 'Yes' : 'No'}<br>
                            Should Be Admin: ${analysis.should_be_admin ? 'Yes' : 'No'}<br>
                            Auth Provider: ${user.auth_provider}<br>
                            Google ID: ${user.google_id || 'N/A'}<br>
                            Active: ${user.is_active ? 'Yes' : 'No'}<br>
                            Created: ${user.created_at ? new Date(user.created_at).toLocaleString() : 'N/A'}<br>
                            <br>
                            <strong>Admin Status: ${analysis.admin_status_correct ? '‚úÖ Correct' : '‚ö†Ô∏è INCORRECT'}</strong>
                        </div>
                    `;
                    
                    if (analysis.admin_issue_detected) {
                        html += `<div class="result error">üö® ISSUE DETECTED: User ${user.email} has admin privileges but should not!</div>`;
                    }
                    
                    html += `<h4>Session Data:</h4><pre>${JSON.stringify(data.session_data, null, 2)}</pre>`;
                } else {
                    html += `<div class="result warning">‚ùå No user currently authenticated</div>`;
                    html += `<h4>Session Data:</h4><pre>${JSON.stringify(data.session_data, null, 2)}</pre>`;
                }
                
                showResult(html, data.authenticated && data.admin_status_analysis?.admin_issue_detected ? 'error' : 'info');
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function searchUserByEmail(email) {
            clearResults();
            try {
                const data = await fetch(`${SESSION_API_BASE}/search-user-by-email/${encodeURIComponent(email)}`).then(r => r.json());
                
                let html = `<h3>üîç Deep Search: ${email}</h3>`;
                
                if (data.exact_match_found) {
                    const user = data.user;
                    const analysis = data.admin_analysis;
                    
                    html += `
                        <div class="user-card ${analysis.unauthorized_admin ? 'unauthorized-admin' : (user.is_admin ? 'expected-admin' : '')}">
                            <strong>${analysis.unauthorized_admin ? 'üö®' : (user.is_admin ? '‚úÖ' : 'üë§')} ${user.email}</strong><br>
                            Name: ${user.first_name || 'N/A'} ${user.last_name || 'N/A'}<br>
                            User ID: ${user.id}<br>
                            Is Admin: ${user.is_admin ? 'Yes' : 'No'}<br>
                            Should Be Admin: ${analysis.should_be_admin ? 'Yes' : 'No'}<br>
                            Auth Provider: ${user.auth_provider}<br>
                            Google ID: ${user.google_id || 'N/A'}<br>
                            Active: ${user.is_active ? 'Yes' : 'No'}<br>
                            Created: ${user.created_at ? new Date(user.created_at).toLocaleString() : 'N/A'}<br>
                            Updated: ${user.updated_at ? new Date(user.updated_at).toLocaleString() : 'N/A'}<br>
                            <br>
                            <strong>Status: ${analysis.admin_status_correct ? '‚úÖ Correct' : 'üö® UNAUTHORIZED ADMIN!'}</strong>
                        </div>
                    `;
                    
                    if (analysis.unauthorized_admin) {
                        html += `<div class="result error">üö® CRITICAL: This user has unauthorized admin privileges!</div>`;
                    }
                } else {
                    html += `<div class="result warning">‚ùå No exact match found for ${email}</div>`;
                    if (data.partial_matches > 0) {
                        html += `<h4>Partial Matches (${data.partial_matches}):</h4>`;
                        data.partial_match_users.forEach(user => {
                            html += `
                                <div class="user-card">
                                    <strong>${user.email}</strong><br>
                                    Name: ${user.first_name} ${user.last_name}<br>
                                    Admin: ${user.is_admin ? 'Yes' : 'No'}<br>
                                    Auth: ${user.auth_provider}
                                </div>
                            `;
                        });
                    }
                }
                
                showResult(html, data.exact_match_found && data.admin_analysis?.unauthorized_admin ? 'error' : 'info');
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function getAllUsersDetailed() {
            clearResults();
            try {
                const data = await fetch(`${SESSION_API_BASE}/all-users-detailed`).then(r => r.json());
                
                let html = `<h3>üë• All Users (Detailed)</h3>`;
                html += `<div class="stats-grid">`;
                html += `<div class="stat-item"><div class="stat-number">${data.total_users}</div><div class="stat-label">Total Users</div></div>`;
                html += `<div class="stat-item"><div class="stat-number">${data.admin_summary.total_admins}</div><div class="stat-label">Admin Users</div></div>`;
                html += `<div class="stat-item"><div class="stat-number">${data.admin_summary.expected_admin_found ? '‚úÖ' : '‚ùå'}</div><div class="stat-label">Expected Admin Found</div></div>`;
                html += `<div class="stat-item"><div class="stat-number">${data.admin_summary.unauthorized_admins.length}</div><div class="stat-label">Unauthorized Admins</div></div>`;
                html += `</div>`;
                
                if (data.admin_summary.unauthorized_admins.length > 0) {
                    html += `<div class="result error">üö® UNAUTHORIZED ADMINS DETECTED!</div>`;
                    html += `<h4>Unauthorized Admin Users:</h4>`;
                    data.admin_summary.unauthorized_admins.forEach(admin => {
                        html += `
                            <div class="user-card unauthorized-admin">
                                <strong>üö® ${admin.email}</strong><br>
                                Name: ${admin.name}<br>
                                Auth Provider: ${admin.auth_provider}<br>
                                <em>This user should NOT have admin privileges!</em>
                            </div>
                        `;
                    });
                }
                
                html += `<h4>All Users:</h4>`;
                data.users.forEach(user => {
                    const isExpected = user.email === 'isky999@gmail.com';
                    const isUnauthorizedAdmin = user.is_admin && !isExpected;
                    const cardClass = isUnauthorizedAdmin ? 'unauthorized-admin' : (user.is_admin ? 'expected-admin' : '');
                    
                    html += `
                        <div class="user-card ${cardClass}">
                            <strong>${isUnauthorizedAdmin ? 'üö®' : (user.is_admin ? '‚úÖ' : 'üë§')} ${user.email}</strong><br>
                            Name: ${user.first_name || 'N/A'} ${user.last_name || 'N/A'}<br>
                            Admin: ${user.is_admin ? 'Yes' : 'No'}<br>
                            Auth: ${user.auth_provider}<br>
                            Created: ${user.created_at ? new Date(user.created_at).toLocaleString() : 'N/A'}
                        </div>
                    `;
                });
                
                showResult(html, data.admin_summary.unauthorized_admins.length > 0 ? 'error' : 'success');
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function debugAuthFlow() {
            clearResults();
            try {
                const data = await fetch(`${SESSION_API_BASE}/debug-auth-flow`).then(r => r.json());
                
                let html = `<h3>üîß Authentication Flow Debug</h3>`;
                
                html += `<h4>Session Information:</h4>`;
                html += `<pre>${JSON.stringify(data.session_info, null, 2)}</pre>`;
                
                html += `<h4>Current User Information:</h4>`;
                html += `<pre>${JSON.stringify(data.current_user_info, null, 2)}</pre>`;
                
                html += `<h4>Auth Headers:</h4>`;
                html += `<pre>${JSON.stringify(data.auth_headers, null, 2)}</pre>`;
                
                showResult(html, 'info');
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function fixSpecificUser(email) {
            if (!confirm(`‚ö†Ô∏è This will remove admin privileges from ${email}. Are you sure?`)) {
                return;
            }
            
            clearResults();
            try {
                const data = await fetch(`${SESSION_API_BASE}/fix-specific-user-admin/${encodeURIComponent(email)}`, {
                    method: 'POST'
                }).then(r => r.json());
                
                let html = `<h3>üîß Fix User Admin Status: ${email}</h3>`;
                
                if (data.success) {
                    html += `<div class="result success">‚úÖ ${data.message}</div>`;
                    html += `
                        <div class="user-card">
                            <strong>${data.user.email}</strong><br>
                            Was Admin: ${data.user.was_admin ? 'Yes' : 'No'}<br>
                            Is Admin Now: ${data.user.is_admin_now ? 'Yes' : 'No'}<br>
                            Status: ${data.user.was_admin && !data.user.is_admin_now ? '‚úÖ Fixed' : '‚ûñ No change needed'}
                        </div>
                    `;
                } else {
                    html += `<div class="result error">‚ùå Failed to fix user</div>`;
                }
                
                showResult(html, data.success ? 'success' : 'error');
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Auto-load stats on page load
        window.addEventListener('load', () => {
            getDatabaseStats();
        });
    </script>
</body>
</html>
